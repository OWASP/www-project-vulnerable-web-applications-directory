{% assign tech_options = "" | split: "," %}
{% assign tech_seen = "" | split: "," %}
{% assign ref_options = "" | split: "," %}
{% assign year_options = "" | split: "," %}

{% for app in include.apps %}
  {% if app.technology %}
    {% for tech in app.technology %}
      {% capture canonical_tech %}
        {% include collection_table/normalize_value.html value=tech %}
      {% endcapture %}
      {% assign canonical_tech = canonical_tech | strip %}
      {% if canonical_tech != "" %}
        {% assign canonical_tech_lc = canonical_tech | downcase %}
        {% unless tech_seen contains canonical_tech_lc %}
          {% assign tech_seen = tech_seen | push: canonical_tech_lc %}
          {% assign tech_options = tech_options | push: canonical_tech %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if app.references %}
    {% for ref in app.references %}
      {% assign ref_name = ref.name | capitalize %}
      {% assign ref_options = ref_options | push: ref_name %}
    {% endfor %}
  {% endif %}

  {% if app.last_contributed %}
    {% assign year_value = app.last_contributed | date: "%Y" %}
    {% assign year_options = year_options | push: year_value %}
  {% endif %}
{% endfor %}

{% assign tech_options = tech_options | uniq | sort %}
{% assign ref_options = ref_options | uniq | sort %}
{% assign year_options = year_options | uniq | sort %}
{% assign year_options_desc = year_options | reverse %}

<div class="advanced-search-modal" id="advanced-search-modal-{{ include.collection }}" data-collection="{{ include.collection }}" aria-hidden="true">
  <div class="advanced-search-overlay" data-advanced-close></div>
  <div class="advanced-search-dialog" role="dialog" aria-modal="true" aria-labelledby="advanced-search-title-{{ include.collection }}" tabindex="-1">
    <button type="button" class="advanced-search-close" data-advanced-close aria-label="Close advanced search">x</button>
    <h2 id="advanced-search-title-{{ include.collection }}">Advanced Search</h2>

    <div class="advanced-search-fields">
      <div class="advanced-field">
        <label for="advanced-search-input-{{ include.collection }}">Keyword Search</label>
        <input type="text" id="advanced-search-input-{{ include.collection }}" class="advanced-search-input" data-collection="{{ include.collection }}" placeholder="Search app name, author, etc...">
      </div>

      <div class="advanced-field">
        <div class="advanced-field-grid">
          <div class="field-left">
            <label id="tech-label-{{ include.collection }}">Technologies</label>
            <div class="multi-select" data-multi-select="tech">
              <button type="button" class="multi-select-trigger" id="tech-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="tech-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="tech-label-{{ include.collection }} tech-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-multi-trigger="tech" data-default-label="Select technologies">Select technologies</button>
              <div class="multi-select-panel" id="tech-panel-{{ include.collection }}" data-multi-panel="tech" hidden tabindex="-1" role="group" aria-labelledby="tech-label-{{ include.collection }}">
                <button type="button" class="multi-select-ok" data-multi-ok="tech">Done</button>
                <div class="multi-select-options">
                  {% for tech in tech_options %}
                  <label class="multi-option">
                    <input type="checkbox" data-collection="{{ include.collection }}" data-multi-option="tech" value="{{ tech | escape }}">
                    {{ tech }}
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="field-right">
            <div class="boolean-select">
              <div class="boolean-label" id="tech-boolean-label-{{ include.collection }}">Boolean</div>
              <div class="single-select" data-single-select="tech-boolean">
                <button type="button" class="single-select-trigger" id="tech-boolean-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="tech-boolean-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="tech-label-{{ include.collection }} tech-boolean-label-{{ include.collection }} tech-boolean-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-single-trigger="tech-boolean" data-default-label="OR">OR</button>
                <div class="single-select-panel" id="tech-boolean-panel-{{ include.collection }}" data-single-panel="tech-boolean" hidden tabindex="-1" role="listbox" aria-labelledby="tech-label-{{ include.collection }} tech-boolean-label-{{ include.collection }}">
                  <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="tech-boolean" data-value="or">OR</button>
                  <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="tech-boolean" data-value="and">AND</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="advanced-field">
        <div class="advanced-field-grid">
          <div class="field-left">
            <label id="refs-label-{{ include.collection }}">References</label>
            <div class="multi-select" data-multi-select="refs">
              <button type="button" class="multi-select-trigger" id="refs-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="refs-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="refs-label-{{ include.collection }} refs-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-multi-trigger="refs" data-default-label="Select references">Select references</button>
              <div class="multi-select-panel" id="refs-panel-{{ include.collection }}" data-multi-panel="refs" hidden tabindex="-1" role="group" aria-labelledby="refs-label-{{ include.collection }}">
                <button type="button" class="multi-select-ok" data-multi-ok="refs">Done</button>
                <div class="multi-select-options">
                  {% for ref in ref_options %}
                  <label class="multi-option">
                    <input type="checkbox" data-collection="{{ include.collection }}" data-multi-option="refs" value="{{ ref | escape }}">
                    {{ ref }}
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="field-right">
            <div class="boolean-select">
              <div class="boolean-label" id="refs-boolean-label-{{ include.collection }}">Boolean</div>
              <div class="single-select" data-single-select="refs-boolean">
                <button type="button" class="single-select-trigger" id="refs-boolean-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="refs-boolean-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="refs-label-{{ include.collection }} refs-boolean-label-{{ include.collection }} refs-boolean-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-single-trigger="refs-boolean" data-default-label="OR">OR</button>
                <div class="single-select-panel" id="refs-boolean-panel-{{ include.collection }}" data-single-panel="refs-boolean" hidden tabindex="-1" role="listbox" aria-labelledby="refs-label-{{ include.collection }} refs-boolean-label-{{ include.collection }}">
                  <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="refs-boolean" data-value="or">OR</button>
                  <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="refs-boolean" data-value="and">AND</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="advanced-field">
        <label id="stars-label-{{ include.collection }}">GitHub Stars</label>
        <div class="single-select" data-single-select="stars">
          <button type="button" class="single-select-trigger single-select-trigger--stars" id="stars-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="stars-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="stars-label-{{ include.collection }} stars-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-single-trigger="stars" data-default-label="Any">Any</button>
          <div class="single-select-panel" id="stars-panel-{{ include.collection }}" data-single-panel="stars" hidden tabindex="-1" role="listbox" aria-labelledby="stars-label-{{ include.collection }}">
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="">Any</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="none">None</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="1">+1</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="100">+100</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="500">+500</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="1000">+1000</button>
            <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="stars" data-value="10000">+10000</button>
          </div>
        </div>
      </div>

      <div class="advanced-field">
        <label id="year-label-{{ include.collection }}">Last Contributed Year</label>
        <div class="year-range">
          <div class="year-field">
            <span class="year-label" id="year-from-label-{{ include.collection }}">From</span>
            <div class="single-select" data-single-select="year-from">
              <button type="button" class="single-select-trigger single-select-trigger--year" id="year-from-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="year-from-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="year-label-{{ include.collection }} year-from-label-{{ include.collection }} year-from-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-single-trigger="year-from" data-default-label="Any">Any</button>
              <div class="single-select-panel" id="year-from-panel-{{ include.collection }}" data-single-panel="year-from" hidden tabindex="-1" role="listbox" aria-labelledby="year-label-{{ include.collection }} year-from-label-{{ include.collection }}">
                <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="year-from" data-value="">Any</button>
                {% for year in year_options_desc %}
                <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="year-from" data-value="{{ year }}">{{ year }}</button>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="year-field">
            <span class="year-label" id="year-to-label-{{ include.collection }}">To</span>
            <div class="single-select" data-single-select="year-to">
              <button type="button" class="single-select-trigger single-select-trigger--year" id="year-to-trigger-{{ include.collection }}" aria-expanded="false" aria-controls="year-to-panel-{{ include.collection }}" aria-haspopup="listbox" aria-labelledby="year-label-{{ include.collection }} year-to-label-{{ include.collection }} year-to-trigger-{{ include.collection }}" data-collection="{{ include.collection }}" data-single-trigger="year-to" data-default-label="Any">Any</button>
              <div class="single-select-panel" id="year-to-panel-{{ include.collection }}" data-single-panel="year-to" hidden tabindex="-1" role="listbox" aria-labelledby="year-label-{{ include.collection }} year-to-label-{{ include.collection }}">
                {% for year in year_options_desc %}
                <button type="button" class="single-option" role="option" aria-selected="false" data-single-option="year-to" data-value="{{ year }}">{{ year }}</button>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="advanced-search-pills-section">
      <div class="advanced-pills-header">
        <div class="advanced-pills-title">Selected Parameters</div>
        <button type="button" class="advanced-clear" data-collection="{{ include.collection }}">Clear</button>
      </div>
      <div class="advanced-pills-surface">
        <div class="filter-pills" data-collection="{{ include.collection }}" data-pill-scope="modal" aria-live="polite"></div>
      </div>
    </div>

    <div class="advanced-search-actions">
      <button type="button" class="advanced-accept" data-collection="{{ include.collection }}">Accept</button>
    </div>
  </div>
</div>
