name: Validate JSON

on: 
  pull_request_target:
    paths:
    - '_data/collection.json'
  workflow_dispatch:


jobs:
  schema-check:
    permissions:
       contents: read  
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        repository: ${{github.event.pull_request.head.repo.full_name}}
    - name: Save PR number
      env:
        PR_NUMBER: ${{ github.event.number }}
      run: echo $PR_NUMBER > pr_number
    - name: Setup Node
      uses: actions/setup-node@v6
      with:
        node-version: 24
    - name: Install dependencies
      run: |
         npm install -g ajv-formats
         npm install -g ajv-cli
    - name: Run schema check
      id: schema
      continue-on-error: true
      run: |
        ajv validate --spec=draft2020 -s schema.json -d _data/collection.json --all-errors --errors=text --verbose=true -c=ajv-formats 1>> schema_log.txt 2>&1
    - name: Run alphabetical ordering check
      id: ordering
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_ordering.py _data/collection.json > ordering_log.txt 2>&1
    - name: Run .editorconfig compliance check
      id: editorconfig
      continue-on-error: true
      run: |
        python3 .github/workflows/scripts/check_editorconfig.py _data/collection.json > editorconfig_log.txt 2>&1
    - name: Create unified artifact and summary
      if: always()
      run: |
        # Initialize artifact file
        echo "**Validation Results**" > artifact.txt
        echo "" >> artifact.txt
        
        # Initialize summary
        echo "# Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Initialize overall status
        overall_status=0
        
        # Schema validation results
        echo "---" >> artifact.txt
        echo "## Schema Validation" >> artifact.txt
        echo "" >> artifact.txt
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## Schema Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.schema.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> artifact.txt
          echo "" >> artifact.txt
          echo "All entries conform to the schema." >> artifact.txt
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All entries conform to the schema." >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> artifact.txt
          echo "" >> artifact.txt
          cat schema_log.txt >> artifact.txt
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat schema_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          overall_status=1
        fi
        echo "" >> artifact.txt
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Alphabetical ordering results
        echo "---" >> artifact.txt
        echo "## Alphabetical Ordering Check" >> artifact.txt
        echo "" >> artifact.txt
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## Alphabetical Ordering Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.ordering.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> artifact.txt
          echo "" >> artifact.txt
          cat ordering_log.txt >> artifact.txt
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ordering_log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> artifact.txt
          echo "" >> artifact.txt
          cat ordering_log.txt >> artifact.txt
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat ordering_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          overall_status=1
        fi
        echo "" >> artifact.txt
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # .editorconfig compliance results
        echo "---" >> artifact.txt
        echo "## .editorconfig Compliance Check" >> artifact.txt
        echo "" >> artifact.txt
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## .editorconfig Compliance Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.editorconfig.outcome }}" == "success" ]; then
          echo "**Status: PASS ✓**" >> artifact.txt
          echo "" >> artifact.txt
          cat editorconfig_log.txt >> artifact.txt
          echo "**Status: PASS ✓**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat editorconfig_log.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status: FAIL ✗**" >> artifact.txt
          echo "" >> artifact.txt
          cat editorconfig_log.txt >> artifact.txt
          echo "**Status: FAIL ✗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat editorconfig_log.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          overall_status=1
        fi
        echo "" >> artifact.txt
        echo "---" >> artifact.txt
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        
        # Exit with error if any check failed
        exit $overall_status
    - name: Upload validation results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: artifact
        path: |
          artifact.txt
          pr_number
